{% from 'macro/__frame__.html' import frame_search, page_navigation %}
{% import 'macro/__article__.html' as article_side %}
{% extends "framework.html" %}
{% block script %}
<!-- bootstrap summernote edit tool css -->
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/summernote.css') }}" crossorigin="anonymous">
<!-- bootstrap summernote edit tool js -->
<script src="{{ url_for('static', filename = 'js/summernote.min.js') }}" crossorigin="anonymous"></script>
<!--<script src="{{ url_for('static', filename = 'lang/summernote-zh-CN.min.js') }}" crossorigin="anonymous"></script>-->

<script src="{{ url_for('static', filename = 'js/markdown.js') }}" crossorigin="anonymous"></script>
<script src="{{ url_for('static', filename = 'js/to-markdown.js') }}" crossorigin="anonymous"></script>

<!-- bootstrap markdown edit tool css -->
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/bootstrap-markdown.min.css') }}" crossorigin="anonymous">
<!-- bootstrap markdown edit tool js -->
<script src="{{ url_for('static', filename = 'js/bootstrap-markdown.min.js') }}" crossorigin="anonymous"></script>

<!-- bootstrap tags input css -->
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/bootstrap-tagsinput.css') }}" crossorigin="anonymous">
<!-- bootstrap tags input js -->
<script src="{{ url_for('static', filename = 'js/bootstrap-tagsinput.min.js') }}" crossorigin="anonymous"></script>
<!-- bootstrap validator css -->
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/bootstrapValidator.min.css') }}" crossorigin="anonymous">
<!-- bootstrap validator js -->
<script src="{{ url_for('static', filename = 'js/bootstrapValidator.min.js') }}" crossorigin="anonymous"></script>
<!-- bootstrap validator css -->
<link rel="stylesheet" href="{{ url_for('static', filename = 'css/fileinput.min.css') }}" crossorigin="anonymous">
<!-- bootstrap validator js -->
<script src="{{ url_for('static', filename = 'js/fileinput.min.js') }}" crossorigin="anonymous"></script>
<!--<script src="{{ url_for('static', filename = 'js/formValidation.js') }}" crossorigin="anonymous"></script>-->
<script type="text/javascript">
    // 移除tab中的校验信息
    function remove_pane_hint(tabId){
        $('a[href="#' + tabId + '"][data-toggle="tab"]')
                .parent()
                .find('i')
                .removeClass('fa-check fa-times');
    }
    $(document).ready(function() {
        // 初始化下拉框，比如文章目录
        $('.selectpicker').selectpicker({
            style: 'btn-info',
            liveSearch: true,
            size: 6
        });
        // 上传文件限制
        $("#inputArticleImage").fileinput({
            allowedFileExtensions: ['jpg', 'jpeg', 'png', 'gif'],
            maxFileSize: 1000,
            maxFilesNum: 1
        });


        var MAX_OPTIONS = 5;
        var form = $('#blogArticleForm');
        form
                .bootstrapValidator({
                    framework: 'bootstrap',
                    excluded: [':disabled'],
                    message: 'This value is not valid',
                    feedbackIcons: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        title: {
                            validators: {
                                notEmpty: {
                                    message: 'The article title required and cannot be empty'
                                }
                            }
                        },
                        source_id: {
                            validators: {
                                notEmpty: {
                                    message: 'The article source required and cannot be empty'
                                }
                            }
                        },
                        category_id: {
                            validators: {
                                notEmpty: {
                                    message: 'The article category required and cannot be empty'
                                }
                            }
                        },
                        summernote_content:{
                            validators: {
                                callback: {
                                    message: 'The content is required and cannot be empty',
                                    callback: function(value, validator, $field) {
                                        var code = $('[name="summernote_content"]').summernote('code');
                                        // <p><br></p> is code generated by Summernote for empty content
                                        return (code !== '' && code !== '<p><br></p>');
                                    }
                                }
                            }
                        },
                        keywords: {
                            validators: {
                                callback: {
                                    message: 'Please enter 1-5 keywords you like most.',
                                    callback: function (value, validator, $field) {
                                        // Get the entered elements
                                        var options = validator.getFieldElements('keywords').tagsinput('items');
                                        return (options !== null && options.length >= 1 && options.length <= 5);
                                    }
                                }
                            }
                        },
                        'reference_links_box[]': {
                            validators: {
                                uri: {
                                    allowLocal: true,
                                    message: 'The input is not a valid URL'
                                }

                            }
                        }
                    }
                })


                .on('error.field.bv', function(e, data) {
                    //console.log('error.field.bv -->', data.element);
                    var $tabPane = data.element.parents('.tab-pane'),
                            tabId    = $tabPane.attr('id');

                    $('a[href="#' + tabId + '"][data-toggle="tab"]')
                            .parent()
                            .find('i')
                            .removeClass('fa-check')
                            .addClass('fa-times');
                })
                .on('success.field.bv', function(e, data) {
                    //console.log('success.field.bv -->', data.element);
                    var $tabPane = data.element.parents('.tab-pane'),
                            tabId    = $tabPane.attr('id'),
                            $icon    = $('a[href="#' + tabId + '"][data-toggle="tab"]')
                                    .parent()
                                    .find('i')
                                    .removeClass('fa-check fa-times');


                })
                .on('added.field.bv', function(e, data) {
                    //console.log('Added element -->', data.field, data.element);
                    if (data.field === 'reference_links_box[]') {
                        if (form.find(':visible[name="reference_links_box[]"]').length >= MAX_OPTIONS) {
                            form.find('a.addReferenceLinks').attr('disabled', 'disabled');
                        }
                    }
                })
                .on('removed.field.bv', function(e, data) {
                    //console.log('Removed element -->', data.field, data.element);
                    if (data.field === 'reference_links_box[]') {
                        if (form.find(':visible[name="reference_links_box[]"]').length < MAX_OPTIONS) {
                            form.find('a.addReferenceLinks').removeAttr('disabled');
                        }
                    }
                })
                // 点击加号，添加引用链接，点击减号，删除引用链接
                .on('click', 'a.addReferenceLinks', function() {
                    var index = $(this).data('index');
                    if (!index) {
                        index = 1;
                        $(this).data('index', 1);
                    }
                    index++;
                    $(this).data('index', index);

                    var     $templateEle = $('#url_reference_link_template'),
                            $row         = $templateEle.clone().removeAttr('id').insertBefore($templateEle).removeClass('hide'),
                            $el          = $row.find('input').eq(0).attr('name', 'reference_links_box[]');
                    $('#blogArticleForm').bootstrapValidator('addField', $el);

                    // Set random value for checkbox and textbox
                    $el.attr('placeholder', 'URL #' + index);


                    $row.on('click', 'a.removeReferenceLinks', function(e) {
                        $('#blogArticleForm').bootstrapValidator('removeField', $el);
                        $row.remove();
                    });
                })

                // 处理关键词标签的校验
                .find('[name="keywords"]')
                // Revalidate the cities field when it is changed
                .change(function (e) {
                    form.bootstrapValidator('revalidateField', 'keywords');
                })
                .end()
                // 对富文本编辑器的初始化和校验
                .find('#summernote_edit_tool')
                .summernote({
                    height: 280,                 // set editor height
                    minHeight: null,             // set minimum height of editor
                    maxHeight: null              // set maximum height of editor
                })
                .on('summernote.change', function(customEvent, contents, $editable) {
                    // Revalidate the content when its value is changed by Summernote
                    $('#blogArticleForm').bootstrapValidator('revalidateField', 'summernote_content');
                })
                .end()
                // 切换富文本编辑器和markdown编辑器
                .find('div.tabs-x .nav-tabs [data-toggle="tab"]')
                .on('tabsX.click', function (event) {
                    var editor_tool = this.getAttribute('href');
                    var markdown_pane = $('#markdown');
                    var summernote_pane = $('#summernote');
                    switch (editor_tool) {
                        case '#summernote':
                            remove_pane_hint('markdown');
                            $("#markdown").addClass("disabled");
                            $("#summernote").removeClass("disabled");
                            form.bootstrapValidator('removeField', 'markdown_content');
                            markdown_pane.addClass('hide');
                            summernote_pane.removeClass('hide');
                            form.bootstrapValidator('addField', 'summernote_content', {
                                validators: {
                                    callback: {
                                        message: 'The content is required and cannot be empty',
                                        callback: function(value, validator, $field) {
                                            var code = $('[name="summernote_content"]').summernote('code');
                                            // <p><br></p> is code generated by Summernote for empty content
                                            return (code !== '' && code !== '<p><br></p>');
                                        }
                                    }
                                }
                            });
                            break;
                        case '#markdown':
                            remove_pane_hint('summernote');
                            $("#summernote").addClass("disabled");
                            $("#markdown").removeClass("disabled");
                            form.bootstrapValidator('removeField', 'summernote_content');
                            summernote_pane.addClass('hide');
                            markdown_pane.removeClass('hide');
                            form.bootstrapValidator('addField', 'markdown_content', {
                                validators: {
                                    callback: {
                                        message: 'The content is required and cannot be empty',
                                        callback: function(value, validator, $field) {
                                            var code = $('[name="markdown_content"]').data('markdown').parseContent();
                                            // <p><br></p> is code generated by Summernote for empty content
                                            return (code !== '' && code !== '<p><br></p>');
                                        }
                                    }
                                }
                            });
                            break;
                    }
                })
                .end()
                // 文章来源icheck初始化和校验
                .find('input:radio[name="source_id"]')
                // Init icheck elements
                .iCheck({
                    // The tap option is only available in v2.0
                    tap: true,
                    radioClass: 'iradio_square-green',
                    increaseArea: '20%'
                })
                // Called when the radios/checkboxes are changed
                .on('ifChanged', function(e) {
                    // Get the field name
                    var field = $(this).attr('name');
                    form.bootstrapValidator('revalidateField', field);
                })
                .end();

    });
    //    向关键词输入框中添加历史关键词
    function add_history_keyword(keyword){
        var keyword_input = $('[name="keywords"]');
        keyword_input.tagsinput('add', keyword);
    }
</script>
{% endblock script %}
{% block title %}Write Article{% endblock title %}
{% block content %}
<!-- 面板 -->
<div class="panel panel-default">
    <!-- Default panel contents -->
    <div class="panel-heading">
        <h4>&nbsp;Write Article</h4>
    </div>

    <div class="panel-body">
        <form class="form-horizontal" id="blogArticleForm" method="post" enctype="multipart/form-data"
              action="{% if article %}{{ url_for('resource.new_article', username=current_user.name, article_id=article.id) }}{% else %}{{ url_for('resource.new_article', username=current_user.name) }}{% endif %}">
            <div class="form-group">
                <label for="inputArticleTitle" class="col-sm-2 control-label">Title</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="inputArticleTitle" name="title" value="{{ article.title }}" placeholder="Article Title">
                </div>
            </div>

            <div class="form-group">
                <label for="inputArticleSource" class="col-sm-2 control-label">Source</label>
                <div class="col-sm-10">
                    <ul id="inputArticleSource" style="margin: 0; padding: 0; list-style: none">
                        {% for source in article_sources %}
                        <li>
                            <input type="radio" {% if article.source_id|string == source.id|string %}checked{% endif %} id="{{ source.id }}" value="{{ source.id }}" name="source_id">&nbsp;
                            <label for="{{ source.id }}">{{ source.name }}</label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="form-group">
                <label for="selectCategory" class="col-sm-2 control-label">Category</label>
                <div class="col-sm-10">
                    <select class="selectpicker" id="selectCategory" name="category_id">
                        {% for category in article_categorys %}
                        <option value="{{ category.id }}" {% if article.category_id|string == category.id|string %}class="active" selected {% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    &nbsp;
                    <a class="link" href="{{ url_for('resource.category', username=current_user.name) }}"><span class="fa fa-plus"></span></a>
                </div>
            </div>
            <div class="form-group">
                <label for="inputArticleImage" class="col-sm-2 control-label">Article Image</label>
                <div class="col-sm-10">
                    <input type="file" class="form-control file" id="inputArticleImage" data-show-upload="false" name="image">
                </div>
            </div>
            <div class="form-group">
                <label for="inputArticleContent" class="col-sm-2 control-label">Content</label>
                <div class="col-sm-10">
                    <!-- tabs -->
                    <div class="tabs-x align-center tabs-above tab-bordered" id="inputArticleContent">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#summernote" data-toggle="tab">Normal</a></li>
                            <li><a href="#markdown" data-toggle="tab">Markdown</a></li>
                        </ul>
                        <div class="tab-content" id="article_edit_pane">
                            <div class="tab-pane active" id="summernote">
                                <textarea id="summernote_edit_tool" name="summernote_content">{% if article.content_type == "summernote" %}{{ article.content }}{% endif %}</textarea>
                            </div>
                            <div class="tab-pane" id="markdown">
                                <textarea name="markdown_content" data-provide="markdown" style="resize: none; display: block;" rows="14" id="bootstrap_markdown_edit_tool">{% if article.content_type == "markdown" %}{{ article.content }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="inputKeywords" class="col-sm-2 control-label">Keywords</label>
                <div class="col-sm-10">
                    <div class="input-group">
                        <input type="text" name="keywords" id="inputKeywords" value="{{ article.keywords_string }}" class="form-control" data-role="tagsinput" />
                    </div><!-- /input-group -->
                </div>
                <div class="col-sm-2">
                </div>
                <div class="col-sm-10">
                    <div class="alert alert-warning">
                        {% for keyword in article_keywords %}
                        <a href="javascript:void(0);" onclick="add_history_keyword('{{ keyword.name }}')">
                            <span class="label label-{{ keyword.color }}">{{ keyword.name }}</span>
                        </a>
                        {% endfor %}
                    </div>

                </div>
            </div>

            {% for reference_link in article.reference_links %}
            {% if loop.index == 1 %}
            <div class="form-group">
                <label class="col-sm-2 control-label">Reference links</label>
                <div class="col-sm-10">
                    <div class="input-group">
                                    <span class="input-group-addon">
                                        <a href="javascript:void(0);" class="addReferenceLinks"><i class="glyphicon glyphicon-plus"></i></a>
                                    </span>
                                    <span class="input-group-addon">
                                        <i class="glyphicon glyphicon-link"></i>
                                    </span>
                        <input type="text" class="form-control" value="{{reference_link.name}}" name="reference_links_box[]">
                    </div>
                </div>
            </div>
            {% else %}
            <div class="form-group">
                <label class="col-sm-2 control-label">
                </label>
                <div class="col-sm-10">
                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <a href="javascript:void(0);" class="removeReferenceLinks"><i class="glyphicon glyphicon-plus"></i></a>
                                        </span>
                        <span class="input-group-addon"><i class="glyphicon glyphicon-link"></i></span>
                        <input type="text" class="form-control" value="{{reference_link.name}}" name="reference_links_box[]">
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="form-group">
                <label for="inputReferenceLinks" class="col-sm-2 control-label">Reference links</label>

                <div class="col-sm-10">
                    <div class="input-group">
                            <span class="input-group-addon">
                                <a href="javascript:void(0);" class="addReferenceLinks"><i class="glyphicon glyphicon-plus"></i></a>
                            </span>
                            <span class="input-group-addon">
                                <i class="glyphicon glyphicon-link"></i>
                            </span>
                        <input type="text" class="form-control" id="inputReferenceLinks" name="reference_links_box[]" placeholder="URL #1">
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="form-group hide" id="url_reference_link_template">
                <label class="col-sm-2 control-label">
                </label>
                <div class="col-sm-10">
                    <div class="input-group">
                            <span class="input-group-addon">
                                <a href="javascript:void(0);" class="removeReferenceLinks"><i class="glyphicon glyphicon-minus"></i></a>
                            </span>
                        <span class="input-group-addon"><i class="glyphicon glyphicon-link"></i></span>
                        <input type="text" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" {% if article.status %}checked{% endif %} value="1" name="status"> Display Status
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" {% if article.permit_comment %}checked{% endif %} value="1" name="permit_comment"> Permit Comment
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="cancel" class="btn btn-default">cancel</button>
                    <button type="preview" class="btn btn-default">preview</button>
                    <button type="submit" class="btn btn-default">Save</button>
                </div>
            </div>
        </form>
    </div>
    <!-- 评论使用 -->
    <div class="panel-footer">
    </div>
</div>

{% endblock content %}

{% block sidebar %}
{{ article_side.article_menu_navigation('New Article') }}
{% endblock sidebar %}
